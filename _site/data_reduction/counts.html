
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146433201-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146433201-1');

</script>
</head>


<link rel="stylesheet" href="/assets/highlight/styles/default.css">

<script src="/assets/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

<title>UCD Bioinformatics Core RNA-Seq Workshop</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="shortcut icon" type="image/png" href="/assets/img/favicon.png">

<meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <link rel="icon" type="image/png"  href="/assets/img/favicon.png">
        <title>UC Davis Bioinformatics Workshop Base Template by ucdavis-bioinformatics-training</title>

        <link rel="stylesheet" href="/assets/css/styles.css?v=22a1bf1e038521d63472a401b032dbdd184191bc">
    <meta name="viewport" content="width=device-width">

<body>
    <div style="background-color: #001A46" class="header sticky" id="myHeader" style="width:100%;">
      <a href="https://bioinformatics.ucdavis.edu/training/" class="logo">
          <img src="/assets/img/biocore_banner.png">
      </a>
        <div>
            <h2 style="float: left;padding-left:10px;padding-top:8px;background-color:#CFB53B; cursor:pointer;">
                <div onclick="doNav()">&#9776; Menu </div>
            </h2>
            <h2 style="border-radius: 0px;padding-top:10px;background-color:#CFB53B;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UC Davis Bioinformatics Workshop Base Template</h2>
        </div>
    </div>
</body>


<div>
    <div id="mySidenav" class="sidenav">
      <!-- <a href="javascript:void(0)" class="closebtn" onclick="doNav()">&times;</a> -->

        <table style="padding-top: 50px">
            
                
                
                  <tr><th><a href="/">Home</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">Introduction</th>
                  
                
                
                  <tr><th><a href="/welcome">Intro to the Workshop and Core</a></th></tr>
                
            
                
                
                  <tr><th><a href="/pdfs/Genomics_a_perspective.pdf">What is Bioinformatics?</a></th></tr>
                
            
                
                
                  <tr><th><a href="/pdfs/ExperimentalDesign.pdf">Experimental Design and Cost Estimation</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">Command-Line and the Cluster</th>
                  
                
                
                  <tr><th><a href="/cli/logging-in">Logging in and Transferring Files</a></th></tr>
                
            
                
                
                  <tr><th><a href="/cli/command-line-intro">Intro to Command-Line</a></th></tr>
                
            
                
                
                  <tr><th><a href="/cli/advanced-command-line">Advanced Command-Line</a></th></tr>
                
            
                
                
                  <tr><th><a href="/cli/cluster">Running jobs on the Cluster and using modules</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">Intro to R and Rstudio</th>
                  
                
                
                  <tr><th><a href="/intro2R/RStudio">Getting Started</a></th></tr>
                
            
                
                
                  <tr><th><a href="/intro2R/Intro2R">Intro to R</a></th></tr>
                
            
                
                
                  <tr><th><a href="/intro2R/data_in_R_prepare">Prepare Data in R (extra)</a></th></tr>
                
            
                
                
                  <tr><th><a href="/intro2R/orig_data_in_R">Data in R (extra)</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">Data Reduction</th>
                  
                
                
                  <tr><th><a href="/data_reduction/filetypes">Files and Filetypes for RNA-Seq</a></th></tr>
                
            
                
                
                  <tr><th><a href="/data_reduction/project_setup">Project Setup</a></th></tr>
                
            
                
                
                  <tr><th><a href="/data_reduction/preproc_htstream">Preprocessing Data</a></th></tr>
                
            
                
                
                  <tr><th><a href="/data_reduction/alignment">Aligners</a></th></tr>
                
            
                
                
                  <tr><th><a href="/data_reduction/counts">Generating Summarized Counts</a></th></tr>
                
            
                
                
                  <tr><th><a href="/data_reduction/salmon">Salmon</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">Support</th>
                  
                
                
                  <tr><th><a href="/cheatSheetIndex">Cheat Sheets</a></th></tr>
                
            
                
                
                  <tr><th><a href="/software">Software and Links</a></th></tr>
                
            
                
                
                  <tr><th><a href="/script_links">Scripts</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">Differential Expression and Pathway Analysis</th>
                  
                
                
                  <tr><th><a href="/differential_expression/de_analysis_prepare">Prepare Differential Expression Analysis</a></th></tr>
                
            
                
                
                  <tr><th><a href="/differential_expression/annotation">Get Gene Annotation</a></th></tr>
                
            
                
                
                  <tr><th><a href="/differential_expression/DE_Analysis">Differential Expression Analysis</a></th></tr>
                
            
                
                
                  <tr><th><a href="/differential_expression/enrichment">Pathway Analysis</a></th></tr>
                
            
                
                
                  <tr><th><a href="/differential_expression/compare_star_salmon">Comparison between STAR and Salmon</a></th></tr>
                
            
                
                  <th style="font-size:22px; color:#CFB53B">ETC</th>
                  
                
                
                  <tr><th><a href="/closing">Closing thoughts</a></th></tr>
                
            
                
                
                  <tr><th><a href="/photos/photos">Workshop Photos</a></th></tr>
                
            
                
                
                  <tr id=Github ><th><a href="https://github.com/ucdavis-bioinformatics-training/2019_August_UCD_mRNAseq_Workshop">Github</a></th></tr>
                
            
                
                
                  <tr id=Biocore website ><th><a href="http://bioinformatics.ucdavis.edu">Biocore website</a></th></tr>
                
            
        </table>
    </div>
</div>


<div id="main" style="padding-left: 50px; padding-right: 50px; margin-left: 300px; padding-top:170px">

<h1 id="from-alignments-to-a-counts-table">From Alignments to a counts table</h1>

<p>This document assumes <a href="/data_reduction/preproc_htstream.html">preproc htstream</a> has been completed.</p>

<p><strong>IF</strong> for some reason it didn’t finish, is corrupted or you missed the session, you can copy over a completed copy</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp -r /share/biocore/workshops/2019_August_RNAseq/02-STAR_alignment /share/workshop/$USER/rnaseq_example/.
cp  /share/biocore/workshops/2019_August_RNAseq/summary_alignments.txt /share/workshop/$USER/rnaseq_example/.
</code></pre></div></div>

<p>In this section, we will collate all of the count data into one file for analysis in R.</p>

<p><strong>1.</strong> First lets make sure we are where we are supposed to be.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /share/workshop/$USER/rnaseq_example
</code></pre></div></div>

<hr />
<p><strong>2.</strong> First, go back to your 02-STAR_alignment directory. Let’s use a wildcard to list all of the counts files from all of the STAR alignment directories:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls -lah 02-STAR_alignment/*/*ReadsPerGene.out.tab
</code></pre></div></div>

<p>Take a look at the beginning of one of these files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>head 02-STAR_alignment/SampleAC1/SampleAC1_ReadsPerGene.out.tab
</code></pre></div></div>

<div class="output">msettles@tadpole:/share/workshop/msettles/rnaseq_example$ head 02-STAR_alignment/SampleAC1/SampleAC1_ReadsPerGene.out.tab
N_unmapped	95519	95519	95519
N_multimapping	213548	213548	213548
N_noFeature	641702	2690321	682539
N_ambiguous	211202	4942	94753
ENSG00000223972.5	3	0	3
ENSG00000227232.5	20	0	20
ENSG00000278267.1	1	0	1
ENSG00000243485.5	0	0	0
ENSG00000284332.1	0	0	0
ENSG00000237613.2	0	0	0
</div>

<p>The columns are ID, reads map to either strand, reads mapped to forward strand, and reads mapped to the reverse strand and the first four lines are category totals. In this experiment, it looks like the reads are from the reverse strand, due to the much higher mapping numbers in that column and they similar to reads mapped to either strands. So what we want is just that column of numbers (minus the first four lines), for every one of these files.</p>

<hr />
<p><strong>3.</strong> So let’s take one file and figure out how to do that, then we will expand it to all the files. First let’s just get the rows we want, i.e. everything but the first four:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -n +5 02-STAR_alignment/SampleAC1/SampleAC1_ReadsPerGene.out.tab | head
</code></pre></div></div>

<p>When you give the ‘-n’ option for the ‘tail’ command a number preceded by a ‘+’ sign, it gives you the entire file starting at the line indicated by the number. In this case, we want to skip the first 4 lines, so we start at line 5. We’re piping the command to ‘head’ just to check that it looks correct. You shouldn’t see the first four total lines.</p>

<p>Now, we want only the fourth column (the counts), and in order to get that we pipe the output of the tail command to the ‘cut’ command, and then redirect the output to a new file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -n +5 02-STAR_alignment/SampleAC1/SampleAC1_ReadsPerGene.out.tab | cut -f4 | head
</code></pre></div></div>

<p>Now, C61_ReadsPerGene.out.tab.count contains a single column of data… counts for each of the genes for that sample.</p>

<hr />

<p><strong>3.</strong> Now, we want to do these steps for ALL of the read count files… and to do that we will be using a ‘for loop’ directly on the command line. First, just run a simple ‘for loop’ that will print out the names of all the files we want to use:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for sample in `cat samples.txt`; do echo ${sample}; done
</code></pre></div></div>

<p>This command takes all the files that we listed in step 1 and loops through them, one by one, and for every iteration, assigns the filename to the ‘${sample}’ variable. Also, for every iteration, it runs whatever commands are between the ‘do’ and ‘done’…. and every iteration the value of ‘${sample}’ changes. The semi-colons separate the parts of the loop. The ‘echo’ command just prints the value of $x to the screen… in this case just the filename. However, instead, we will use our previously created command, but with ${sample} instead of the filename, and adding a few things:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /share/workshop/$USER/rnaseq_example
mkdir 03-Counts
mkdir 03-Counts/tmp
for sample in `cat samples.txt`; do \
    echo ${sample}
    cat 02-STAR_alignment/${sample}/${sample}_ReadsPerGene.out.tab | tail -n +5 | cut -f4 &gt; 03-Counts/tmp/${sample}.count
done
</code></pre></div></div>

<p>After this command, there should be a counts file for every sample, in 03-Counts/tmp.</p>

<hr />
<p><strong>4.</strong> Next, we need to get the columns for the final table. Because all of these files are sorted in the exact same order (by gene ID), we can just use the columns from any of the files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -n +5 02-STAR_alignment/SampleAC1/SampleAC1_ReadsPerGene.out.tab | cut -f1 &gt; 03-Counts/tmp/geneids.txt
head 03-Counts/tmp/geneids.txt
</code></pre></div></div>

<p>Finally, we want to combine all of these columns together using the ‘paste’ command, and put it in a temporary file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>paste 03-Counts/tmp/geneids.txt 03-Counts/tmp/*.count &gt; 03-Counts/tmp/tmp.out
</code></pre></div></div>

<hr />
<p><strong>5.</strong> The final step is to create a header of sample names and combine it with the temp file. The header is just all of the sample names separated by tabs. And again, since we pasted the columns in sorted order (wildcards automatically sort in order), the columns just need to be in that same order.</p>

<p>We take the samples.txt file and pipe that to the sort (to ensure they are in the same order) and then ‘paste’ command with the ‘-s’ option, which takes a column of values and transposes them into a row, separated by the tab character. And finally, let’s put everything together:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;(cat samples.txt | sort | paste -s) 03-Counts/tmp/tmp.out &gt; 03-Counts/rnaseq_workshop_counts.txt
rm -rf 03-Counts/tmp
head 03-Counts/rnaseq_workshop_counts.txt
</code></pre></div></div>

<div class="output">msettles@tadpole:/share/workshop/msettles/rnaseq_example$ head 03-Counts/rnaseq_workshop_counts.txt
SampleAC1	SampleAC2	SampleAC3	SampleAC4	SampleAD1	SampleAD2	SampleAD3	SampleAD4	SampleBC1	SampleBC2	SampleBC3	SampleBC4	SampleBD1	SampleBD2	SampleBD3	SampleBD4
ENSG00000223972.5	3	1	0	0	0	0	0	0	2	0	0	0	0	5	0	0
ENSG00000227232.5	20	7	15	10	7	9	15	26	6	10	6	6	14	10	4	4
ENSG00000278267.1	1	2	1	1	0	1	2	4	0	0	0	0	0	0	1	0
ENSG00000243485.5	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0
ENSG00000284332.1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
ENSG00000237613.2	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
ENSG00000268020.3	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
ENSG00000240361.2	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
ENSG00000186092.6	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
</div>

<p>And now you have a raw counts file that has a count for every gene, per sample. You will use this file for the next step, which is analysis in R.</p>

<p><strong>6.</strong> Transfer rnaseq_workshop_counts.txt and samples.txt to your computer using scp or winSCP, or copy/paste from cat [sometimes doesn’t work],</p>

<p>In a new shell session on your laptop. <strong>NOT logged into tadpole</strong>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/rnaseq_workshop
cd ~/rnaseq_workshop
scp msettles@tadpole.genomecenter.ucdavis.edu:/share/workshop/msettles/rnaseq_example/03-Counts/rnaseq_workshop_counts.txt .
scp msettles@tadpole.genomecenter.ucdavis.edu:/share/workshop/msettles/rnaseq_example/samples.txt .
</code></pre></div></div>

<p>Its ok of the mkdir command fails (“File exists”) because we aleady created the directory earlier.</p>

<p>Open in excel (or excel like application), you may have to move the header column 1 cell to the right, and lets review.</p>

<p><em>Anything else worth discussing?</em></p>


</div>



<script src="/assets/js/scale.fix.js"></script>

<script>
var navopen=1;

function doNav() {
  if (navopen == 1) {
    document.getElementById("mySidenav").style.width = "0px";
    document.getElementById("main").style.marginLeft = "0px";
    document.getElementById("myHeader").style.marginLeft = "0px";
    document.getElementById("mySidenav").style.overflowY = "hidden";
    navopen = 0;
  } else {
    document.getElementById("mySidenav").style.width = "300px";
    document.getElementById("main").style.marginLeft = "300px";
    document.getElementById("myHeader").style.marginLeft = "300px";
    document.getElementById("mySidenav").style.overflowY = "visible";
    navopen = 1;
  }
}

// When the user scrolls the page, execute myFunction
window.onscroll = function() {myFunction()};

// store the sidenav scroll pos for loading or set the pos
sn = document.getElementById("mySidenav");
sn.onscroll = function() {sessionStorage.setItem("scrollpos",sn.scrollTop);};
window.onload = function() {sn.scrollTop = sessionStorage.getItem("scrollpos");};

// Get the header
var header = document.getElementById("myHeader");

// Get the offset position of the navbar
var sticky = header.offsetTop;


function myFunction() {
  var x = document.getElementById("myDIV");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}

</script>
